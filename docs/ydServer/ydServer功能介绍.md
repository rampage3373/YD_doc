引言
==

本文档介绍了易达交易的业务和技术功能，帮助用户全面了解和掌握易达交易系统功能范围。

本文档面向期货公司的业务和技术人员。

交易功能
====

目前易达交易系统支持中金所、上期所、大商所的全部交易品种的交易，具体情况请参考下文详细内容。

交易性能
----

易达交易系统可以提供以下穿透延时性能，该穿透延时可以通过易达提供的免费工具ydSniffer测得。穿透时间被定义为投资者报单进入柜台网卡之前到离开柜台网卡的时间差。

<table>
    <thead>
        <tr>
            <td><strong>测试场景</strong></td>
            <td><strong>席位数</strong></td>
            <td><strong>穿透中位数(纳秒)</strong></td>
            <td><strong>穿透标准差(纳秒)</strong></td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>上期所</td>
            <td>6</td>
            <td>2737</td>
            <td>433</td>    
        </tr>
        <tr>
            <td>上期所</td>
            <td>12</td>
            <td>2833</td>
            <td>575</td>
        </tr>
        <tr>
            <td>中金所</td>
            <td>5</td>
            <td>3006</td>
            <td>482</td>
        </tr>
        <tr>
            <td>大商所</td>
            <td>6</td>
            <td>4756</td>
            <td>826</td>
        </tr>
    </tbody>
</table>    



报单
--

易达交易系统支持以下品种和交易指令：

<table>
    <thead>
        <tr>
            <td><strong>交易所</strong></td>
            <td><strong>支持品种</strong></td>
            <td><strong>交易指令</strong></td>
            <td><strong>期权行权</strong></td>
            <td><strong>做市商</strong></td>
            <td>不支持业务</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>上期所&能源所</td>
            <td>所有期货、期权</td>
            <td>普通限价、FAK、FOK</td>
            <td>申请执行 取消自动行权</td>
            <td>支持</td>
            <td></td>
        </tr>
        <tr>
            <td>大商所</td>
            <td>所有期货、期权</td>
            <td>普通限价、FAK、FOK</td>
            <td>申请执行</td>
            <td>支持</td>
            <td>套利合约</td>
        </tr>
        <tr>
            <td>中金所</td>
            <td>所有期货、期权</td>
            <td>普通限价、FAK、FOK</td>
            <td></td>
            <td>支持</td>
            <td></td>
        </tr>
        <tr>
            <td>郑商所</td>
            <td>所有期货、期权</td>
            <td>普通限价、FAK、FOK</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>

*   **指定席位：**报单可以指定交易席位，由投资者选择其认为最优席位进行报单，通常需要投资者自行识别出最优席位。
*   **批量委托和撤单：**在同一个报单调用内，发送最多不超过16个报单，相比逐个发送报单，能有效降低整体延时。
*   **遇忙排队：**当遇到多个报单争用同一个席位报单时，后到的报单会触发遇忙排队功能，报单会串行排队等待发送，最长等待时间为5毫秒，考虑到易达交易系统优异的穿透性能，通常情况下报单能很快报送出去，不会有大量拥堵产生。
*   **扩展交易接口：**易达交易系统希望投资者自行管理资金和持仓，这有益于获得更高的性能。为了顾及部分投资者的使用习惯，易达提供了扩展交易接口，可以提供普通柜台类似的查询功能，如查询持仓、资金、委托成交等，需要注意的是，使用扩展交易接口可能会带来一定的性能开销，需要投资者权衡使用。
*   **CTP应用直连：**为了方便现有CTP应用能直接迁移至易达交易系统，可以通过替换CTP动态链接库的方式使得现有应用能直接接入易达交易系统，原有应用无需任何修改。Linux平台和Windows平台均有支持。

席位
--

### 席位管理

易达交易系统支持全管理席位、首管理席位其他非管理席位和全非管理席位三种席位模式。

当使用全管理席位时，用户可以在所有席位撤单，而不需要专门在报单席位撤单，有利于撤单速度的提升和减少席位占用冲突。易达交易系统只在第一个席位订阅了会员流和行情流，其他席位不订阅任何流水，因此，不用担心流量问题。

当使用首席位管理其他席位非管理席位时，系统将自行选择报单席位进行撤单。易达交易系统只在第一个席位订阅了会员流和行情流，其他席位不订阅任何流水，因此，不用担心流量问题。

当使用全非管理席位时，系统将自行选择报单席位进行撤单。易达交易系统会在所有席位订阅席位流，但只在第一个席位订阅行情流。

### 流量控制

本系统支持所有交易所席位的流量控制，可配置每个交易所的流量。

### 多席位

本系统在所有交易所均支持单套系统同时连接多个席位。受CPU核数的限制，在当前推荐CPU的条件下，易达系统最多支持12个席位。

由于大商所的交易接口本身不支持，易达在原交易所接口的基础上进行了包装，使其能够支持多席位连接。考虑到监管问题，我们将包装源代码放在易达柜台上，并使用现场编译的方式产生多席位版本的动态链接库。

### 多交易所

本系统支持在一套系统上同时连接多个交易所，主要用于上期所、能源交易所同时部署，以及搭建基于交易所仿真环境的测试环境。生产环境中，由于本系统都是部署在托管机房中，因此，不建议使用多交易所功能。

做市商
---

本系统支持做市商业务，包括接收报价申请、提交与撤销报价、批量提交与批量撤销报价等做市商交易指令，并支持相应的风控规则。

结合本系统“CTP应用直连”（参见报单）功能，使得原有基于CTP的做市商应用无需任何修改便能直接接入易达交易系统。

系统管理
====

投资者管理
-----

投资者管理包括开销户、重置密码、报单量控制和交易权限设置等功能，其中重置密码、交易权限设置可以盘中修改生效，其他设置均需重新启动易达交易系统后生效。

### 报单量控制

由于易达交易系统采用的内存数据库的最大报单上限为4,194,304（4096\*1024）笔，为了防止某投资者意外大量报单占满内存数据库导致所有用户都无法正常交易的情况发生，可对每个投资者设置最大报单量上限。

每个投资者的报单量上限独立，当报单到达上限后，即不允许继续报单。为了避免容量浪费，所有投资者的总报单量上限可以超过4,194,304，但是不宜超过太多，具体数量可以根据每个投资者的历史交易情况进行调整。

### 设置交易权限

支持在账户、交易所、产品和合约层面对投资者的交易权限进行设置，可以设置的权限包括：允许交易、只能平仓和禁止交易。投资者缺省允许交易。需要注意，交易权限仅适用于报单请求，撤单总是允许的。

如果某投资者存在多个维度的交易权限设置，这是允许的，其实际的交易权限按照所有这些权限设置项中的覆盖规则进行覆盖得出最终权限。

权限的覆盖规则为：禁止交易覆盖只能平仓和允许交易、只能平仓覆盖允许交易。

系统支持设置默认权限，例如可以为投资者适当性产品设置默认禁止交易的权限，以达到新客户默认不可交易投资者适当性产品的效果。默认权限可以通过为单个客户设置交易权限来覆盖。

管理员管理
-----

管理员管理包括管理员开销户、重置密码、权限管理和访问网段控制功能，其中重置密码可以盘中修改生效，其他设置均需重新启动易达交易系统后生效。

### 权限管理

支持对每个管理员分别设置其在ydClient中的权限，可以设置的权限项及其权限范围见下表。如没有定义管理员权限，则该管理员在ydClient中只有只读权限。

Web管理端不受此权限限制。

|**权限项**|**说明**|
|---------|--------|
|**Trading**|代替投资者交易的权限|
|**SetTradingRight**|可以在ydClient中实时设置所有账户的交易权限|
|**AlterMoney**|可以在ydClient中实时进行出入金操作（ydSync使用的账号需要此权限）|
|**ManageAccount**|在ydClient中可以修改投资者口令，在ydAdmin中可以开户、销户、修改账户、修改投资者口令|
|**ManageAdminUser**|在ydClient中可以修改其他管理员口令，在ydAdmin中可以对管理员账户增删改，可以修改其他管理员口令|
|**ManageAppAuthCode**|在YDAdmin中可以管理软件认证码|

### 访问网段控制

为了防止投资者通过暴力破解管理员密码取得易达交易系统的控制权限，本系统可以限制管理员登录的网段，这样就可以从根本上杜绝投资者使用管理员账号的可能性。

支持为每个管理员配置登录网段，如果配置了网段，那么管理员必须从配置网段登录，否则将无法登录；如果不配置，则管理员可以从所有的网段登录。

出入金
---

出入金功能包括入金、冻结出金、取消冻结出金和出金。

常规情况下，由于本系统与主交易系统并没有数据交互，因此投资者在主交易系统出入金后，需要由期货公司业务人员在本系统中重复出入金操作后，投资者才能看到出入金的资金影响。

出入金的金额受到资金使用限度的影响，无需手工计算。计算公式如下：

实际出入金金额 = 输入的出入金金额 \* 资金使用限度

#### 入金

入金操作完成后，实际入金金额会立即增加到“可用资金”中，投资者立即可以使用。

#### 出金

出金需要三个步骤方可完成。

首先使用“冻结出金”将投资者需要出金数量冻结掉，冻结出金数量的使用限度部分会立即从“可用资金”中减去，“风险度”也随之上升。

其次检查交易账户的“可用资金”是否为负数，风险度是否可以接受，如果不可接受，需要通过“取消冻结出金”减少冻结出金数量。

最后使用“出金”将投资者需要数量出金，该数量应小于等于前述冻结出金数量。出金后“出金”数量增加指定数量，“冻结出金”随之减少。

#### 出入金自动同步

易达交易系统并不连接主交易系统，因此，通常情况下需要在本系统重复手工出入金操作，为了能减少重复操作的工作量，易达提供了一个资金同步小工具，该工具从CTPRisk中读取出入金流水并同步到易达交易系统之中。

当存在多套易达交易系统时，该工具同时连接所有的易达系统和CTPRisk，可较大程度上减少重复工作，但带来的副作用是，当升级系统时候所有易达交易系统必须同时升级，这可能与通常的运维管理规范不相符，考虑到次席系统出入金次数相对较少，期货公司需要自行评估，权衡好处和副作用，决定是否使用该功能。

风险控制
====

风险控制主要包括资金和持仓的计算方法。

易达系统提供多种资金计算方式，完全覆盖CTP的资金计算方式。

余额
--

余额 = （昨余额 + 入金 – 出金 – 冻结出金）\* 资金使用限度

其中，昨余额等同于CTP的“昨总权益”。

### 资金使用限度

当投资者需要在多套次席系统同时交易时，一般采用修改初始化文件总权益的方式分隔资金，但这种方式容易出错，无法自动按比例分配出入金，也不能盘中动态调整，因此，易达系统使用“资金使用限度”来满足这个需求。

易达系统支持通过设置资金使用限度分隔多套系统的资金，只要每套系统的资金使用限度加总不超过100%，就可以保证金不会透支。资金使用限度缺省设置为100%，此时昨余额全部可用。

盘中可以使用ydClient调整资金使用限度，以灵活适应投资者的资金需求，但盘中设置的资金使用限度停止系统后即失效，若要永久设置，可在web管理界面中设置。

例如，我们有三套易达系统，某投资者昨余额为100万元，在各个交易所的保证金分别为CFFEX=0/DCE=30/SHFE=10万元，其资金使用限度分别为CFFEX=0.4/DCE=0.3/SHFE=0.3。

在易达交易系统启动后，该投资者的昨余额为CFFEX=40/DCE=30/SHFE=30万元，可用资金为CFFEX=40/DCE=0/SHFE=20万元。开盘后，该投资者发现DCE有大量交易机会，业务人员可以在盘中动态调整该投资者的资金使用限度，譬如调整为CFFEX=0.1/DCE=0.7/SHFE=0.2，此时昨余额为CFFEX=10/DCE=70/SHFE=20万元，可用资金为CFFEX=10/DCE=40/SHFE=10万元，该投资者可以继续在DCE交易。

上述设置过程如下表所示。



||**CFFEX**|**DCE**|**SHFE**|
|-----|-------|------|------|
|**保证金占用**|0|30|10|
|**启动后资金使用限度**|0.4|0.3|0.3|
|**启动后昨余额**|40|30|30|
|**启动后可用资金**|40|0|20|
|**开盘后资金使用限度**|0.1|0.7|0.2|
|**开盘后昨余额**|10|70|20|
|**开盘后可用资金**|10|40|10|

期货保证金
-----

### 委托保证金

委托保证金 = \[价格\] \* 合约乘数 \* 保证金率 \* 手数

根据易达柜台配置的价格类型不同，上述\[价格\]可能是昨结算、报单价（对于市价单，使用涨停板价）。

### 持仓保证金

昨仓保证金=昨结算 \* 合约乘数 \* 保证金率 \* 手数

今仓保证金=\[价格\] \* 合约乘数 \* 保证金率 \* 手数

根据易达柜台配置的价格类型不同，上述\[价格\]可能是昨结算、开仓价、最新价、市场均价、最新价和昨结算的大者。其中，昨结算、开仓价作为保证金价格类型时，保证金为静态值，盘中不会变动；最新价、市场均价、最新价和昨结算的大者这三种保证金价格类型需要在盘中调用API刷新。

请注意，在计算组合持仓节约的保证金时，永远基于昨结算价。

期权权利金
-----

### 委托权利金

期权买方委托权利金 = 报单价（对于市价单，使用涨停板价） \* 合约乘数

期权卖方委托权利金 = \[价格\] \* 合约乘数

根据易达柜台配置的价格类型不同，上述\[价格\]可能是昨结算价、报单价、无，当使用“无”时，期权卖方不会在报单时获得保证金。

### 成交权利金

成交权利金 = 成交价 \* 合约乘数

期权保证金
-----

### 基础公式

委托和持仓保证金的计算公式是相同的，在此统一列出。

#### 商品期权

商品期权空方的每手保证金 = \[价格\] \* 合约乘数 + max ( 期货保证金 – 期权虚值 / 2, 期货保证金 / 2 )

期货保证金 = 标的期货昨结算价 \* 标的期货合约乘数 \* 标的期货保证金率

看涨期权虚值 =  max( ( 行权价 – 标的期货昨结算价 ) \* 合约乘数, 0)

看空期权虚值 =  max( ( 标的期货昨结算价 - 行权价 ) \* 合约乘数, 0)

#### 股指期权

股指期权空方的每手保证金 = \[价格\] \* 合约乘数 + max ( 标的指数昨收盘价 \* 合约乘数 \* 合约保证金调整系数 – 期权虚值, 最低保障系数 \* 标的指数昨收盘价 \* 合约乘数 \* 合约保证金调整系数 )

看涨期权虚值 =  max( ( 行权价 – 标的指数昨收盘价 ) \* 合约乘数, 0)

看空期权虚值 =  max( ( 标的指数昨收盘价 - 行权价 ) \* 合约乘数, 0)

### 委托保证金

根据易达柜台配置的价格类型不同，委托保证金的\[价格\]可能是昨结算、报单价（对于市价单，使用涨停板价）。

### 持仓保证金

根据易达柜台配置的价格类型不同，持仓保证金的\[价格\]可能是昨结算、开仓价、最新价、市场均价、最新价和昨结算的大者。其中，昨结算、开仓价作为保证金价格类型时，保证金为静态值，盘中不会变动；最新价、市场均价、最新价和昨结算的大者这三种保证金价格类型需要在盘中调用API刷新。

请注意，在计算组合持仓节约的保证金时，永远基于昨结算价。

### 行权申请保证金

期权行权申请报单中冻结的保证金永远是基于昨结算价的。

大边保证金
-----

易达交易系统对各个期货交易所的大边保证金支持情况如下。

**中金所**

支持跨产品、产品、合约的大边保证金。

支持合约到期前退出大边保证金计算。

可以强行关闭大边保证金功能。

**上期所**

支持合约、产品的大边保证金。

支持合约到期前退出大边保证金计算。

可以强行关闭大边保证金功能。

**大商所**

支持盘前、盘中组合大边保证金。

平仓盈亏
----

每手期货/期权的平仓盈亏 = ( 平仓价 - 开仓均价 ) \* 合约乘数

按照先开先平的持仓明细顺序，逐笔计算平仓盈亏。

持仓盈亏
----

每手期货/期权的持仓盈亏 = ( 市场价 - 开仓均价 ) \* 合约乘数

ydServer会定期（可配置）根据市场价对每个账户不同合约的持仓进行持仓盈亏计算。

市场价为持仓相同方向价格：

*   多头市场价：买一价；如无买一价则为最新价；如无最新价则为涨停价格；如无涨停价格则为前收盘。
*   空头市场价：卖一价；如无卖一价则为最新价；如无最新价则为跌停价格；如无跌停价格则为前收盘。

ydClient风控终端并不是定期计算，而是每条行情都更新持仓盈亏。

手续费
---

成交手续费=成交价格 \* 合约乘数 \* 手续费率 \* 成交手数 + 成交手数 \* 每手费用

报单和撤单手续费按照报单、撤单次数来计算，目前只有中金所适用。

需要注意的是，中金所的成交手续费按照后开先平的原则执行，与之相对的是，中金所的平仓盈亏仍然按照先开先平的方式执行。

考虑到手续费的风险较小，与报单时刻撤单数量和成交、限仓等数量的“悲观”限制不同，报单时刻ydServer并不冻结交易账户的手续费。成交的手续费在收到成交回报时根据各交易账户的手续费率扣除；撤单手续费在收到撤单回报时根据各交易账户的手续费率扣除。

可用资金
----

可用资金 = 余额 + 平仓盈亏（盈为正，亏为负）– 手续费  + 期权权利金 – 期货保证金 - 持仓亏损 – 期权行权保证金。

请注意，持仓盈亏盈利部分不计加，持仓盈亏亏损部分计减。

监管合规
====

持仓和交易合规
-------

本系统全方面支持仓位和交易的监管合规风控，如下表所示。



||**产品层面**|**合约层面**|
|-----|-----------|------------|
|**持仓**|产品总持仓量 产品多头持仓量 产品空头持仓量|合约持仓量 合约多头持仓量 合约空头持仓量|
|**交易**|产品开仓量 产品买入开仓量 产品卖出开仓量 产品撤单笔数 产品成交量|合约开仓量 合约买入开仓量 合约卖出开仓量 合约撤单笔数 合约成交量|

需要注意，对于区分今日新仓和昨仓的合约，合约多头或空头限仓是按照今仓和昨仓是分开限制的。

自成交检测
-----

本系统支持自成交检查，能有效防止投资者因自成交被交易所监管的问题。

虽然交易所宽限了一定的自成交数量，自成交检查比较严格，不允许任何的自成交产生。同时，只有当交易所返回全部成交的回报或者撤单回报后，该委托才会从本系统的订单簿中移除，因此，在这之前的可能自成交的报单都无法报送，需要投资者控制报单的发送节奏。

如期货公司认为不需要自成交检查，则可以关闭该功能。

穿透式监管
-----

本系统严格按照保证金监控中心的要求，实现穿透式监管功能。

期货公司首先要在本系统中为每个投资者分配AppID和AppAuthCode，投资者使用他们才能登录系统。

每次登录，系统都会按照监控中心要求记录下投资者的各种信息，供上报监控中心使用。

系统运行
====

授权文件
----

授权文件是易达交易系统能正常启动的前提条件，签订测试协议或者正式合同后，我们会签发授权文件。

下表说明了授权文件中的关键要素。

|**配置项**|**说明**|
|---------|--------|
|**起止日期**|起止日期限定了授权文件的有效时间，当系统日期超过起止日期后，系统将无法启动。|
|**用户数**|本系统支持的最大用户数为32个用户，当系统中开立的用户超过这个限制后系统将无法启动。 只要系统能正常启动，每个投资者的连接是不限数量的。|
|**绑定席位**|绑定席位是指必须出现在本套易达环境中的席位，期货公司必须指定一个席位为绑定席位，该席位在授权文件的有效期内不可变更。 系统启动时，会检查授权文件中的绑定席位是否在席位清单中，如果不在，则系统无法启动。 除了绑定席位有限制之外，其他席位没有任何限制，期货公司可随时调整席位。|
|**是否测试环境**|如果期货公司想要搭建基于交易所仿真环境的测试环境，我方可以签发起止日期与生产环境相同的授权文件，该授权文件只能用于测试版本的软件。 测试版本的软件包与生产版本的软件包不同，不包括任何加速特性。|

日初数据
----

易达交易系统目前仅支持CTP的冒烟文件作为日初数据，在每日CTP结算完成后，需要将CTP的冒烟文件放置到指定位置上，本系统启动后，会抽取并转换CTP数据至易达系统的日初数据格式。

随着易达交易系统功能的不断增加，会使用更多的冒烟文件中的数据，因此，我们建议使用全量的冒烟数据包，而不要做数据过滤和文件筛选。

如果确实需要过滤和筛选的，请单独联系我们提供相应版本的文件清单。

启动模式
----

本系统的启动模式有日盘启动、夜盘启动、冒烟启动和数据稽核启动四种。

### 日夜盘启动

日盘启动和夜盘启动属于常规的启动模式，这两种模式会正常加载日初数据并启动系统至可交易状态。

如果启动时日初数据尚不存在，则会等到两个小时，如果两小时内数据到达，则继续正常启动，如果超过两小时数据还未到达，则启动失败。

如果启动时交易所的系统尚未启动，则会等待直至其启动完成，在此期间本系统不可访问。

对于有夜盘交易的交易所，日盘启动时会自动加载夜盘的交易。

### 冒烟启动

期货公司可能存在核对系统日初数据的需求，如果等待交易系统启动后检查，时间可能偏晚。易达系统提供了冒烟启动模式，即在不连接交易所的情况下，使用当天的日初数据加载并打开系统，使得期货公司业务人员能及早检查日初数据。

本系统的行情数据从交易所直接获取，由于此时系统无法连接交易所，因此冒烟启动时日初行情无法更新，只能使用前一交易日的日初行情打开系统，这会造成保证金、可用资金等一系列资金不准确的问题。

期货公司需要权衡利弊决定是否使用该启动模式。

### 数据稽核启动

为了确保日初数据的准确性，本系统可以以数据稽核模式启动，该启动模式不会真正启动系统，而仅仅是检查日初数据的勾稽关系。

目前该功能在生产中没有应用，当在测试环境中需要自己构造数据的时候，这个功能可以用来检查手工创建的日初数据是否正确。

应急处置
----

如果因为服务器掉电、重启等导致本系统异常停止的，本系统支持在任意时间重启系统以解决问题，启动后本系统会自动恢复到停止之前的状态。

问题检查
----

为了方便期货公司技术人员检查易达系统的相关问题，本系统提供了详细的日志和流水文件，主要包括报单流水、交易流水文件和日志文件。

报单流水文件包含所有的投资者报单，除了报单号、合约、数量、价格等合约基本信息之外，还额外提供了实际报送使用的席位号以及实际使用的UDP线程号等信息。

交易流水文件包含了完整的业务初始化过程和委托成交回报，可以用来检查投资者的实际交易情况。

日志文件则是技术性文件，包括了系统启动过程、错误信息、投资者连接信息和心跳信息等诸多技术信息。该文件是监控易达交易系统的核心，当系统发生异常时，首先应该检查日志文件。另外，投资者的自成交错单也会出现在该文件中，便于帮助投资者排查冲突情况。

版本控制
----

为防止投资者使用错误版本的客户端登录系统，造成交易错乱和损失，易达交易系统会检查连接的客户端版本是否符合兼容性要求，如果本系统不支持该客户端版本，则会主动断开连接，并在日志文件中打印错误信息。

数据备份
----

每天日夜盘交易结束后，本系统会自动备份除了可执行程序之外的所有数据，以备日后检查所用。
