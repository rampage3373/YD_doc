为方便开发人员管理钱和仓，以下将详细说明易达交易系统中计算钱仓的方式。


由于不同期货公司可能会选择不同的保证金、权利金的价格计算类型，因此，用户需要根据实际柜台的选择来计算。


## 期货保证金


### 委托保证金


委托每手保证金 = [价格] * 合约乘数 * 保证金率 + 每手保证金率


根据易达柜台配置的价格类型不同，上述[价格]可能是昨结算、报单价（对于市价单，使用涨停板价）。


### 持仓保证金


昨仓每手保证金 = 昨结算 * 合约乘数 * 保证金率 + 每手保证金率


今仓每手保证金 = [价格] * 合约乘数 * 保证金率 + 每手保证金率


根据易达柜台配置的价格类型不同，上述[价格]可能是昨结算、开仓价、最新价、市场均价、最新价和昨结算的大者。其中，昨结算、开仓价作为保证金价格类型时，保证金为静态值，盘中不会变动；最新价、市场均价、最新价和昨结算的大者这三种保证金价格类型需要在盘中调用API刷新。


请注意，在计算组合持仓节约的保证金时，永远基于昨结算价。


## 期权权利金


### 委托权利金


期权买方委托权利金 = 报单价（对于市价单，使用涨停板价） * 合约乘数


期权卖方委托权利金 = [价格] * 合约乘数


根据易达柜台配置的价格类型不同，上述[价格]可能是昨结算价、报单价、无，当使用“无”时，期权卖方不会在报单时获得保证金。


### 成交权利金


成交权利金 = 成交价 * 合约乘数


## 期权保证金


### 基础公式


委托和持仓保证金的计算公式是相同的，在此统一列出。


#### 商品期权


商品期权空方的每手保证金 = [期权价格] * 期权合约乘数 + max ( 基础保证金 – 期权虚值 / 2, 基础保证金 / 2 )


基础保证金 = [基础合约价格] * 基础合约乘数 * 基础合约保证金率 + 基础合约每手保证金率


看涨期权虚值 = max( ( 行权价 – [基础合约价格] ) * 期权合约乘数, 0)


看空期权虚值 = max( ( [基础合约价格] - 行权价 ) * 期权合约乘数, 0)


#### 股指期权


看涨期权空方的每手保证金 = [期权价格] * 期权合约乘数 + max ( [基础合约价格] * 基础合约乘数 * 保证金调整系数 – 期权虚值, 最低保障系数 * [基础合约价格] * 基础合约乘数 * 保证金调整系数 )


看跌期权空方的每手保证金 = [期权价格] * 期权合约乘数 + max ( [基础合约价格] * 基础合约乘数 * 保证金调整系数 – 期权虚值, 最低保障系数 * 行权价 * 基础合约乘数 * 保证金调整系数 )


看涨期权虚值 = max( ( 行权价 – [基础合约价格] ) * 期权合约乘数, 0)


看空期权虚值 = max( ( [基础合约价格] - 行权价 ) * 期权合约乘数, 0)


#### ETF期权


易达从公式上并不区分线性和非线性计算方式，我们通过参数控制最终采用的保证金计算方法。例如，当线性系数为1.2，其他参数为交易所标准值时，本质采用的线性模式；当基础合约保证金率为15%，最低保障系数为8%，而线性系数为1时，本质采用的是非线性模式。


看涨期权空方的每手保证金 = 线性系数 * ( [期权价格] + max( 基础合约保证金率 * [基础合约价格] - 虚值度, 最低保障系数 * [基础合约价格] )) * 期权合约乘数


其中，虚值度 = max(行权价 - [基础合约价格], 0)


看跌期权空方的每手保证金 = 线性系数 * ( [期权价格] + min(max(基础合约保证金率 * [基础合约价格] - 虚值度, 最低保障系数 * 行权价), 行权价 - 期权最新价)) * 期权合约乘数


其中，虚值度 = max([基础合约价格]-行权价, 0)


### 委托保证金


根据易达柜台配置的价格类型不同，委托保证金的[期权价格]默认为昨结算，可能是昨结算、报单价（对于市价单，使用涨停板价）；委托保证金的[基础合约价格]默认为昨结算价，可能是昨结算价、最新价、最新价和昨结算的大者。


### 持仓保证金


根据易达柜台配置的价格类型不同，持仓保证金的[期权价格]默认为最新价和昨结算的大者，可能是昨结算、开仓价、最新价、市场均价、最新价和昨结算的大者；持仓保证金的[基础合约价格]默认为昨结算价，可能是昨结算价、最新价、最新价和昨结算的大者。其中，昨结算、开仓价作为保证金价格类型时，保证金为静态值，盘中不会变动；最新价、市场均价、最新价和昨结算的大者这三种保证金价格类型需要在盘中调用API刷新。


### 行权申请保证金


期权行权申请报单中冻结的保证金永远是基于昨结算价的。


## 平仓盈亏


每手期货多头平今仓盈亏 = ( 平仓价 - 开仓价 ) * 合约乘数

每手期货多头平昨仓盈亏 = ( 平仓价 - 昨结算 ) * 合约乘数

每手期货空头平今仓盈亏 = ( 开仓价 - 平仓价 ) * 合约乘数

每手期货空头平昨仓盈亏 = ( 昨结算 - 平仓价 ) * 合约乘数


按照先开先平的持仓明细顺序，逐笔计算平仓盈亏。


## 持仓盈亏


期货多头持仓盈亏 = ( 最新价 * (昨持仓量 + 今持仓量) - 开仓价 * 今持仓量 - 昨结算 * 昨持仓量 ) * 合约乘数

期货空头持仓盈亏 = ( 开仓价 * 今持仓量 + 昨结算 * 昨持仓量 - 最新价 * (昨持仓量 + 今持仓量) ) * 合约乘数


ydServer每隔5秒（可配置）根据市场当前价格对每个账户不同合约的持仓进行持仓盈亏计算。系统采用的价格为持仓相同方向价格与开仓均价之差来计算持仓盈亏，多空方都以当前最新价计算；如果没有最新价则为昨结算价。


## 手续费


成交手续费=成交价格 * 合约乘数 * 手续费率 * 成交手数 + 成交手数 * 每手费用


报单和撤单手续费按照报单、撤单次数来计算，目前只有中金所适用。


需要注意的是，中金所的成交手续费按照后开先平的原则执行，与之相对的是，中金所的平仓盈亏仍然按照先开先平的方式执行。


考虑到手续费的风险较小，与报单时刻撤单数量和成交、限仓等数量的“悲观”限制不同，报单时刻ydServer并不冻结交易账户的手续费。成交的手续费在收到成交回报时根据各交易账户的手续费率扣除；撤单手续费在收到撤单回报时根据各交易账户的手续费率扣除。


## 可用资金


余额 = （昨余额 + 入金 – 出金 – 冻结出金）* 使用限度，使用限度缺省设置为100%，因此昨余额全部可用。如果该账户在多家交易所的多柜台系统使用，需要分配使用限度。总限度不得超过100%。


可用 = 余额 + 平仓盈亏（盈为正，亏为负）– 手续费 + 期权权利金 – 期货保证金 - 持仓亏损 – 期权执行保证金。



## 组合保证金


### 上交所


<figure class="wp-block-table alignwide is-style-stripes">
    <table>
        <tbody>
            <tr>
                <td><strong>组合策略</strong></td>
                <td><strong>头寸1</strong></td>
                <td><strong>头寸2</strong></td>
                <td><strong>计算公式</strong></td>
            </tr>
            <tr>
                <td>认购牛市价差策略</td>
                <td>低<br>权利</td>
                <td>高<br>义务</td>
                <td>0</td>
            </tr>
            <tr>
                <td>认沽熊市价差策略</td>
                <td>高<br>权利</td>
                <td>低<br>义务</td>
                <td>0</td>
            </tr>
            <tr>
                <td>认购熊市价差策略</td>
                <td>低<br>义务</td>
                <td>高<br>权利</td>
                <td>（认购期权权利仓行权价格-认购期权义务仓行权价格）* 合约单位</td>
            </tr>
            <tr>
                <td>认沽牛市价差策略</td>
                <td>高<br>义务</td>
                <td>低<br>权利</td>
                <td>（认沽期权义务仓行权价格-认沽期权权利仓行权价格）* 合约单位</td>
            </tr>
            <tr>
                <td>跨式空头策略</td>
                <td>同价<br>义务<br>认购</td>
                <td>同价<br>义务<br>认沽</td>
                <td>max（认购期权开仓保证金，认沽期权开仓保证金）+开仓保证金较低的成分合约前结算价*合约单位<br>当开仓保证金相等时，上述公式中开仓保证金较低的成分合约前结算价，取认购期权前结算价和认沽期权前结算价两者中的较大值。</td>
            </tr>
            <tr>
                <td>宽跨式空头策略</td>
                <td>高<br>义务<br>认购</td>
                <td>低<br>义务<br>认沽</td>
                <td>max（认购期权开仓保证金，认沽期权开仓保证金）+开仓保证金较低的成分合约前结算价*合约单位<br>当开仓保证金相等时，上述公式中开仓保证金较低的成分合约前结算价，取认购期权前结算价和认沽期权前结算价两者中的较大值。</td>
            </tr>
        </tbody>
    </table>
</figure>
